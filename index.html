<!DOCTYPE html>
<html lang="en">
<head>
<title>Web Audio Playground</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<link rel="shortcut icon" href="Speaker.ico">

<!-- Visual design for nodes in the page -->
<link rel="stylesheet" href="nodes.css" type="text/css">

<!-- Script functions for dragging nodes around the page and connecting -->
<script type="text/javascript" src="dragging.js"></script>

<!-- Dial Control library -->
<script type="text/javascript" src="DialControl.js"></script>


<script type="text/javascript">
var audioContext = null;

var tempx=100, tempy=100;

function createNewNode( nodeType, input, output ) {
	var e=document.createElement("div");
	e.className="node " + nodeType;
	e.style.left="" + tempx + "px";
	if (tempx > 500)
		tempx = 100;
		else
		tempx += 50;
	e.style.top="" + tempy + "px";
	if (tempy > 1000)
		tempy = 100;
		else
		tempy += 50;
	e.setAttribute("audioNodeType", nodeType );
	e.onmousedown=startDraggingNode;
	e.appendChild(document.createTextNode(nodeType));
	
	if (input) {
		var i=document.createElement("div");
		i.className="inputconnector";
		i.onmousedown=startDraggingConnector;
		e.appendChild(i);
	}
	
	if (output) {
		var i=document.createElement("div");
		i.className="outputconnector";
		i.onmousedown=startDraggingConnector;
		e.appendChild(i);
	}
	
	// add the node into the soundfield
	document.getElementById("soundField").appendChild(e);
	return(e);
}

function hitplay(e) {
  	e = e.target.parentNode; // the node element, not the play button.

	// if there's already a note playing, cut it off.
	if (e.audioNode)
		e.audioNode.noteOff(0);
	
	// create a new BufferSource, set it to the buffer and connect it.
	e.audioNode = audioContext.createBufferSource();
	e.audioNode.loop = e.getElementsByTagName("input")[0].checked;
	
	if (e.dstNode)
		e.audioNode.connect( e.dstNode.audioNode );

  	e.audioNode.buffer = e.buffer;
	e.audioNode.noteOn(0);
}

function hitstop(e) {
	e.target.parentNode.audioNode.noteOff(0);
}

function flipLoop(e) {
	e.target.checked = !e.target.checked;
	if (e.target.parentNode.audioNode)
		e.target.parentNode.audioNode.loop = e.target.checked;
}

function onUpdateQ(e) {
	var param = e.parentNode.audioNode.Q;
	
	var i = parseFloat(e.getAttribute("val"));	// in range 0.0 - 100.0
	var range = param.maxValue - param.minValue;
	param.value = ((i * range) / 100) + param.minValue;
	//	console.log( e.parentNode.audioNode.frequency.value + "Hz Q=" + e.parentNode.audioNode.Q.value + "\n");
}

function onUpdateFrequency(e) {
	var param = e.parentNode.audioNode.frequency;
	
	var i = parseFloat(e.getAttribute("val"));	// in range 0.0 - 100.0
	var range = param.maxValue - param.minValue;
	param.value = ((i * range) / 100) + param.minValue;
//	console.log( e.parentNode.audioNode.frequency.value + "Hz Q=" + e.parentNode.audioNode.Q.value + "\n");
}

function initDefaultParam(param) {
	var range = param.maxValue - param.minValue;
	param.value = param.defaultValue;
	return ((param.value - param.minValue) * 100) / range;
}

function createBiquadFilterNode() {
	var e=createNewNode("biquadFilter", true, true );
	var filter = audioContext.createBiquadFilter();
	e.audioNode = filter;
	filter.type=0;
//	filter.frequency.value = 440.0;

	var ctl = createNewDialControl( 50, initDefaultParam(filter.Q) );
	ctl.style.left = "10px";
	ctl.style.top = "20px";
	ctl.onUpdateDial = onUpdateQ;
	e.appendChild( ctl );

	ctl = createNewDialControl( 50, initDefaultParam(filter.frequency) );
	ctl.style.left = "70px";
	ctl.style.top = "20px";
	ctl.onUpdateDial = onUpdateFrequency;
	e.appendChild( ctl );

}

function createAudioNodeFromBuffer( buffer ) {
	var e=createNewNode("audioBufferSource", false, true );

	e.buffer=buffer;
	
	var ctl=document.createElement("button");
	ctl.appendChild(document.createTextNode("play"));
	ctl.onclick = hitplay;
	e.appendChild(ctl);

	ctl=document.createElement("button");
	ctl.appendChild(document.createTextNode("stop"));
	ctl.onclick = hitstop;
	e.appendChild(ctl);

	ctl=document.createElement("input");
	ctl.type="checkbox";
	ctl.name="loop";
	ctl.value="loop";
	ctl.addEventListener( "onclick", flipLoop );
	e.appendChild(ctl);
	e.appendChild(document.createTextNode("loop  "));

}

function flipNormalize(e) {
	e.target.checked = !e.target.checked;
	if (e.target.parentNode.audioNode)
		e.target.parentNode.audioNode.normalize = e.target.checked;
}

function createConvolverNodeFromBuffer( buffer ) {
	var e=createNewNode("convolverNode", true, true );
	var convolver = audioContext.createConvolver();
	
	e.audioNode = convolver;
	e.buffer=buffer;
	convolver.buffer = buffer;
	
	ctl=document.createElement("input");
	ctl.type="checkbox";
	ctl.name="normalize";
	ctl.value="normalize";
	ctl.addEventListener( "onclick", flipNormalize );
	e.appendChild(document.createElement("br"));
	e.appendChild(ctl);
	e.appendChild(document.createTextNode("normalize"));
}

function downloadAudioFromURL( url ){
	var request = new XMLHttpRequest();
  	request.open('GET', url, true);
  	request.responseType = 'arraybuffer';

  	// Decode asynchronously
  	request.onload = function() {
    	audioContext.decodeAudioData( request.response, function(buffer) {
      		createAudioNodeFromBuffer(buffer);
    	}, function(){alert("error loading!");});
  	}
  	request.send();
}

function downloadImpulseFromURL( url ){
	var request = new XMLHttpRequest();
  	request.open('GET', url, true);
  	request.responseType = 'arraybuffer';

  	// Decode asynchronously
  	request.onload = function() {
    	audioContext.decodeAudioData( request.response, function(buffer) {
      		createConvolverNodeFromBuffer(buffer);
    	}, function(){alert("error loading!");});
  	}
  	request.send();
}

// Set up the page as a drop site for audio files. When an audio file is
// dropped on the page, it will be auto-loaded as an AudioBufferSourceNode.
function initDragDropOfAudioFiles() {
	window.ondragover = function () { this.className = 'hover'; return false; };
	window.ondragend = function () { this.className = ''; return false; };
	window.ondrop = function (e) {
  		this.className = '';
  		e.preventDefault();

	  var reader = new FileReader();
	  reader.onload = function (event) {
	  	audioContext.decodeAudioData( event.target.result, function(buffer) {
	    		createAudioNodeFromBuffer(buffer);
	  	}, function(){alert("error loading!");} ); 

	  };
	  reader.onerror = function (event) {
	    alert("Error: " + reader.error );
	  };
	  reader.readAsArrayBuffer(e.dataTransfer.files[0]);
	  return false;
	};	
}

// Initialization function for the page.
function init() {
  	try {
    	audioContext = new webkitAudioContext();
  	}
  	catch(e) {
    	alert('Web Audio API is not supported in this browser');
  	}

	initDragDropOfAudioFiles();	// set up page as a drop site for audio files

	// create the one-and-only destination node for the context
	var dest = createNewNode("destination", true, false );
	dest.style.backgroundImage = "url(Speaker_Icon_gray.svg)";
	dest.style.backgroundSize = "contain";
	dest.audioNode = audioContext.destination;
}

window.addEventListener('load', init, false);

</script>
<style>

</style>
</head>

<body>
<div id="soundField">
<div>Drop a sound file onto the page in order to create an AudioBufferSource with that file</div>
<button onclick="downloadAudioFromURL('440Hz.ogg'); ">Sine Wave AudioBufferSource</button>
<button onclick="createBiquadFilterNode();">Biquad Filter</button>
<button onclick="downloadImpulseFromURL('hall.ogg'); ">Hall Impulse ConvolutionNode</button>

<button onclick="var uri=prompt('Enter a URL to a sound file'); if (uri) downloadAudioFromURL(uri); ">AudioBufferSource from URL</button>
<button onclick="var uri=prompt('Enter a URL to an impulse file'); if (uri) downloadImpulseFromURL(uri); ">Convolver from impulse file URL</button>

</div>
<!-- SVG canvas is just for drawing the connector lines -->
<svg id=svgCanvas xmlns="http://www.w3.org/2000/svg" version="1.1"  
  style="width:100%; height:100%; position:absolute; top:0; left:0; z-index:-1;">  
</svg>
</body>
</html>
